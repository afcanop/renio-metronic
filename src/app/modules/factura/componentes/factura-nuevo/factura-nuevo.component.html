<form [formGroup]="formularioFactura" (ngSubmit)="formSubmit()">
  <div class="row mb-10">
    <div class="col-12">
      <label class="form-label required">Cliente</label>
      <div class="position-relative">
        <input
          type="text"
          class="form-control form-control"
          minlength="3"
          maxlength="4"
          name="card_cvv"
        />
        <div class="position-absolute translate-middle-y top-50 end-0 me-3">
          <i class="bi bi-search fs-1x"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-10">
    <div class="col-12">
      <label class="form-label required">Movimiento tipo</label>
      <div class="position-relative">
        <input
          type="text"
          class="form-control form-control"
          minlength="3"
          maxlength="4"
          name="card_cvv"
          formControlName="movimiento_tipo"
        />
        <div class="position-absolute translate-middle-y top-50 end-0 me-3">
          <i class="bi bi-search fs-1x"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-10">
    <div class="col">
      <label class="form-label required">Fecha de factura</label>
      <input
        formControlName="fechaFactura"
        class="form-control bg-transparent"
        type="datetime-local"
        autocomplete="off"
      />
    </div>
    <div class="col">
      <label class="form-label required">Fecha vencimiento</label>
      <input
        formControlName="fechaVencimiento"
        class="form-control bg-transparent"
        type="datetime-local"
        autocomplete="off"
      />
    </div>
  </div>

  <div class="row mb-10">
    <div class="col">
      <label class="form-label required">Plazo</label>
      <input
        formControlName="plazo"
        class="form-control bg-transparent"
        type="number"
        autocomplete="off"
      />
    </div>
    <div class="col">
      <label class="form-label required">Tipo de Documento</label>
      <input
        formControlName="tipoDocumento"
        class="form-control bg-transparent"
        type="text"
        autocomplete="off"
      />
    </div>
  </div>

  <div class="row mb-10">
    <div class="col">
      <label class="form-label required">URL para Anexos? </label>
      <input
        formControlName="url"
        class="form-control bg-transparent"
        type="url"
        autocomplete="off"
      />
    </div>
    <div class="col">
      <label class="form-label required">Tipo de operación</label>
      <input
        formControlName="tipoOperacion"
        class="form-control bg-transparent"
        type="text"
        autocomplete="off"
      />
    </div>
  </div>

  <div class="row mb-10">
    <div class="col-6">
      <label class="form-label required">Método de pago</label>
      <input
        formControlName="metodoPago"
        class="form-control bg-transparent"
        type="text"
        autocomplete="off"
      />
    </div>
  </div>

  <div class="row mb-10">
    <div class="col-12">
      <ul
        ngbNav
        #nav="ngbNav"
        [(activeId)]="active"
        class="nav nav-tabs nav-line-tabs nav-line-tabs-2x mb-5 fs-6"
      >
        <li [ngbNavItem]="1" [destroyOnHide]="true" class="nav-item">
          <a class="nav-link" ngbNavLink data-bs-toggle="tab">Lista </a>
          <ng-template ngbNavContent>
            <div class="table-responsive-sm">
              <table id="tableDetalles" class="table table-row-dashed table-row-gray-500">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio</th>
                    <th>Descuento</th>
                    <th>Impuesto</th>
                    <th>Imp Incluidos</th>
                    <th class="text-center">
                      <button
                        (click)="agregarProductos()"
                        class="btn btn-sm btn-primary"
                        type="button"
                      >
                        Agregar item
                      </button>
                    </th>
                  </tr>
                </thead>
                <tbody formArrayName="detalles">
                  <ng-container
                    *ngFor="let detalle of detalles.controls; let i = index"
                    [formGroupName]="i"
                  >
                    <tr>
                      <td>
                        <app-comun-productos
                          (emitirArrItems)="actualizarDetalles($event, i)"
                        ></app-comun-productos>
                      </td>
                      <td>
                        <textarea
                          class="o_input"
                          formControlName="cantidad"
                          [value]="detalle.value?.cantidad"
                          (change)="actualizarDetalle(i, 'cantidad', $event)"
                          rows="1"
                          spellcheck="true"
                        ></textarea>
                      </td>
                      <td>
                        <textarea
                          class="o_input"
                          [value]="detalle.value.precio"
                          (change)="actualizarDetalle(i, 'precio', $event)"
                          rows="1"
                          spellcheck="true"
                        ></textarea>
                      </td>
                      <td>
                        <textarea
                          class="o_input"
                          [value]="detalle.value.descuento"
                          (change)="actualizarDetalle(i, 'descuento', $event)"
                          rows="1"
                          spellcheck="true"
                        ></textarea>
                      </td>
                      <td>
                        <app-comun-impuestos
                          (emitirImpuestos)="actualizarImpuesto($event, i)"
                          (emitirImpuesto)="removerImpuesto($event, i)"
                        ></app-comun-impuestos>
                      </td>
                      <td>
                        <textarea
                          [value]="
                            detalle.value.cantidad * detalle.value.precio
                          "
                          (blur)="onImpuestoBlur(i)"
                          readonly
                          rows="1"
                          spellcheck="true"
                        ></textarea>
                      </td>
                      <td class="text-center">
                        <i
                          class="bi bi-trash fs-2x align-self-center cursor-pointer user-select-none text-hover-danger"
                          (click)="eliminarProducto(i)"
                        ></i>
                      </td>
                    </tr>
                  </ng-container>
                </tbody>
              </table>
            </div>
            <div class="d-flex flex-column justify-content-end align-items-end">
              <table>
                <tr *ngIf="totalCantidad > 0">
                  <td class="text-end">Total Cantidad:</td>
                  <td class="text-end">{{ totalCantidad | currency : "$" }}</td>
                </tr>
                <tr *ngFor="let impuesto of visualizadorImpuestos">
                  <td class="text-end">{{impuesto.nombre}}</td>
                  <td class="text-end">{{ impuesto.total | currency : "$" }}</td>
                </tr>
                <tr *ngIf="totalDescuento > 0">
                  <td class="text-end">Total Descuento:</td>
                  <td class="text-end">{{ totalDescuento | currency : "$" }}</td>
                </tr>
                <tr *ngIf="totalImpuestos > 0">
                  <td class="text-end">Total Impuestos:</td>
                  <td class="text-end">{{ totalImpuestos | currency : "$" }}</td>
                </tr>
                <tr class="border-top">
                  <td class="text-end">Total General:</td>
                  <td class="text-end " style="padding-left: 24px;">{{ totalGeneral | currency : "$"  }}</td>
                </tr>
              </table>
            </div>
          </ng-template>
        </li>
        <li [ngbNavItem]="2" [destroyOnHide]="true" class="nav-item">
          <a class="nav-link" ngbNavLink data-bs-toggle="tab"
            >Otra inforamación</a
          >
          <ng-template ngbNavContent> </ng-template>
        </li>
      </ul>
      <div [ngbNavOutlet]="nav" class="mt-2"></div>
    </div>
  </div>

  <div class="d-flex justify-content-end mb-10">
    <button
      type="submit"
      class="btn btn-primary btn-sm"
      #btnGuardar
      translate="FORMULARIOS.BOTONES.COMUNES.GUARDAR"
    ></button>
  </div>
</form>
